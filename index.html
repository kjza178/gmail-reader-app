<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>📩 Gmail Inbox Viewer (Real-Time)</title>
    <style>
        body { margin: 0; font-family: sans-serif; background: #f4f6f9; }
        header { background: #2c7be5; color: white; padding: 1rem; font-size: 20px; }
        .container { display: flex; height: calc(100vh - 56px); }
        .sidebar { width: 50%; background: white; padding: 20px; overflow-y: auto; border-right: 1px solid #ccc; }
        .content { width: 50%; padding: 20px; background: #fafafa; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #f0f0f0; }
        button { padding: 6px 12px; background: #2c7be5; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px; }
        button:hover { background: #1a5fd0; }
        .setup-btn { background: #28a745; }
        .setup-btn:hover { background: #218838; }
        .status-badge { font-size: 0.8em; padding: 2px 6px; border-radius: 3px; color: white; }
        .status-2fa { background: #28a745; }
        .status-warning { background: #ffc107; color: #000; }
        .status-none { background: #6c757d; }
    </style>
</head>
<body>
<header>📩 Gmail Inbox Viewer (Real-Time)</header>
<div class="container">
    <div class="sidebar">
        <h2>📤 Import Email List</h2>
        <form method="post" enctype="multipart/form-data">
            <input type="file" name="file" accept=".txt">
            <button type="submit" name="action" value="upload">📥 Tải lên</button>
        </form>

        {% if accounts %}
        <h3>🔐 Setup 2FA & App Password</h3>
        <div style="margin-bottom: 15px;">
            <button onclick="setupAll2FA()" class="setup-btn">🔐 Setup 2FA cho tất cả</button>
            <button onclick="check2FAStatus()" style="background: #17a2b8;">📊 Kiểm tra trạng thái</button>
        </div>

        <h3>📋 Danh sách email</h3>
        <table>
            <thead><tr><th>#</th><th>Email</th><th>2FA</th><th></th></tr></thead>
            <tbody>
                {% for acc in accounts %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ acc[0] }}</td>
                    <td>
                        <span class="status-badge status-none" id="status-{{ loop.index0 }}">❓ Chưa check</span>
                    </td>
                    <td style="text-align: center;">
                        <button onclick="startLogin('{{ loop.index0 }}')" style="margin-right: 5px;">🌐 Browser</button>
                        <button onclick="refreshUnreadEmails('{{ loop.index0 }}')" style="background: #17a2b8;">📧 Unread</button>
                        <button onclick="setupSingle2FA('{{ loop.index0 }}')" class="setup-btn">🔐 Setup</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <h3>👋 Quản lý Session</h3>
        <div style="margin-top: 10px;">
            <button onclick="logout()" style="background: #dc3545;">👋 Logout</button>
        </div>
        {% endif %}
    </div>
    <div class="content">
        <h3>📝 Nhật ký hoạt động</h3>
        <ul id="logbox"></ul>
    </div>
</div>

<script>
function startLogin(idx) {
    fetch("/login", {
        method: "POST",
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: "account=" + idx
    });
}

function refreshUnreadEmails(idx) {
    fetch("/refresh-unread", {
        method: "POST",
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: "account=" + idx
    });
}

function setupSingle2FA(idx) {
    fetch("/setup-2fa", {
        method: "POST",
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: "account=" + idx
    });
}

function setupAll2FA() {
    if (confirm("🔐 Bạn có chắc muốn setup 2FA cho tất cả accounts?\n\n⚠️ Quá trình này sẽ:\n- Mở browser cho từng account\n- Setup 2FA và App Password\n- Mất thời gian khoảng 2-3 phút/account")) {
        fetch("/setup-all-2fa", {
            method: "POST",
            headers: {'Content-Type': 'application/x-www-form-urlencoded'}
        });
    }
}

function check2FAStatus() {
    fetch("/check-2fa-status", {
        method: "POST",
        headers: {'Content-Type': 'application/x-www-form-urlencoded'}
    }).then(() => {
        // Sau khi check, cập nhật UI
        update2FAStatus();
    });
}

function update2FAStatus() {
    fetch("/get-2fa-status")
    .then(res => res.json())
    .then(data => {
        if (data.status_data) {
            for (let idx in data.status_data) {
                const statusElement = document.getElementById(`status-${idx}`);
                if (statusElement) {
                    const statusInfo = data.status_data[idx];
                    statusElement.textContent = statusInfo.text;
                    statusElement.className = `status-badge ${statusInfo.class}`;
                }
            }
        }
    })
    .catch(error => {
        console.error('Error updating 2FA status:', error);
    });
}

function logout() {
    fetch("/logout", {
        method: "POST",
        headers: {'Content-Type': 'application/x-www-form-urlencoded'}
    });
}

setInterval(() => {
    fetch("/log")
    .then(res => res.json())
    .then(data => {
        const box = document.getElementById("logbox");
        box.innerHTML = "";
        for (let line of data.logs) {
            const li = document.createElement("li");
            li.innerHTML = line;  // ✅ fix HTML render
            box.appendChild(li);
        }
    });
}, 2000);

// Auto check 2FA status khi load trang
window.onload = function() {
    if (document.querySelector('table')) {
        setTimeout(() => {
            update2FAStatus();
        }, 1000);
    }
};
</script>
</body>
</html>
